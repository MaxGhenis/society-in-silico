---
import Layout from '../../layouts/Layout.astro';
import {
  bookStructure,
  getAllChapters,
  getChapterBySlug,
  getChapterNavigation,
  getChapterPosition,
  estimateReadingTime,
  countWords,
} from '../../lib/book';
import { marked } from 'marked';
import * as fs from 'node:fs';
import * as path from 'node:path';

export function getStaticPaths() {
  const chapters = getAllChapters();
  return chapters.map((chapter) => ({
    params: { slug: chapter.slug },
  }));
}

const { slug } = Astro.params;
const chapter = getChapterBySlug(slug);

if (!chapter) {
  return Astro.redirect('/book');
}

// Read the markdown file
const projectRoot = path.resolve(process.cwd(), '..');
const filePath = path.join(projectRoot, chapter.file);

// Load BibTeX references
const bibPath = path.join(projectRoot, 'references.bib');
const citationData: Record<string, { author: string; year: string; title: string; url?: string }> = {};
try {
  const bibContent = fs.readFileSync(bibPath, 'utf-8');
  const entryRegex = /@\w+\s*\{\s*([^,]+)\s*,([^@]*?)(?=\n@|\n*$)/gs;
  let match;
  while ((match = entryRegex.exec(bibContent)) !== null) {
    const key = match[1].trim();
    const entry = match[2];
    const getField = (field: string) => {
      const m = entry.match(new RegExp(`${field}\\s*=\\s*[{"]([^}"]*)[}"]`, 'i'));
      return m ? m[1].replace(/\{([^}]+)\}/g, '$1').replace(/\s+/g, ' ').trim() : '';
    };
    citationData[key] = {
      author: getField('author').replace(/^\{|\}$/g, '').split(',')[0].split(' and ')[0],
      year: getField('year'),
      title: getField('title'),
      url: getField('url') || (getField('doi') ? `https://doi.org/${getField('doi')}` : undefined),
    };
  }
} catch (e) { /* ignore */ }

// Concept definitions for wiki-links
const concepts: Record<string, { title: string; desc: string }> = {
  'guy-orcutt': { title: 'Guy Orcutt', desc: 'Father of microsimulation (1917-2006)' },
  'policyengine': { title: 'PolicyEngine', desc: 'Open-source tax-benefit microsimulation platform' },
  'openfisca': { title: 'OpenFisca', desc: 'Open-source platform for modeling tax and benefit systems' },
  'taxsim': { title: 'TAXSIM', desc: 'NBER tax microsimulation model' },
  'cosilico': { title: 'Cosilico', desc: 'Infrastructure for simulating society' },
  'ubi-center': { title: 'UBI Center', desc: 'Think tank for universal basic income research' },
  'rules-as-code': { title: 'Rules as Code', desc: 'Movement to express legislation in machine-executable form' },
};

let content = '';
let htmlContent = '';
let readingTime = 0;
let wordCount = 0;
const usedCitations: string[] = [];

try {
  content = fs.readFileSync(filePath, 'utf-8');

  // Process citations: {cite}`key` → superscript with tooltip data
  content = content.replace(/\{cite\}`([^`]+)`/g, (_, key) => {
    const cite = citationData[key];
    if (cite) {
      if (!usedCitations.includes(key)) usedCitations.push(key);
      const num = usedCitations.indexOf(key) + 1;
      const tooltip = `${cite.author}, ${cite.year}`;
      return `<sup class="cite" data-key="${key}" data-tip="${tooltip}" data-url="${cite.url || ''}">[${num}]</sup>`;
    }
    return '';
  });

  // Process wiki-links: [[entity]] → concept with tooltip
  content = content.replace(/\[\[([^\]]+)\]\]/g, (_, entity) => {
    const slug = entity.toLowerCase().replace(/\s+/g, '-');
    const concept = concepts[slug];
    if (concept) {
      return `<span class="concept" data-tip="${concept.desc}">${concept.title}</span>`;
    }
    return entity.replace(/-/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
  });

  // Remove other MyST-specific syntax
  content = content
    .replace(/\{ref\}`[^`]+`/g, '')
    .replace(/\{numref\}`[^`]+`/g, '')
    .replace(/```\{figure\}[\s\S]*?```/g, '')
    .replace(/```\{note\}[\s\S]*?```/g, '')
    .replace(/```\{warning\}[\s\S]*?```/g, '')
    .replace(/```\{bibliography\}[\s\S]*?```/g, '')
    .replace(/## References\s*$/gm, '')
    .replace(/  +/g, ' ');

  // Configure marked for nice typography
  marked.setOptions({
    gfm: true,
    breaks: false,
  });

  htmlContent = await marked.parse(content);
  readingTime = estimateReadingTime(content);
  wordCount = countWords(content);
} catch (error) {
  console.error(`Error reading chapter file: ${filePath}`, error);
  htmlContent = '<p class="text-[var(--color-ink-muted)]">This chapter is coming soon.</p>';
}

// Build references section
let refsHtml = '';
if (usedCitations.length > 0) {
  refsHtml = '<div class="refs"><h3>References</h3><ol>';
  for (const key of usedCitations) {
    const c = citationData[key];
    if (c) {
      const link = c.url ? `<a href="${c.url}" target="_blank">${c.author} (${c.year}). ${c.title}</a>` : `${c.author} (${c.year}). ${c.title}`;
      refsHtml += `<li>${link}</li>`;
    }
  }
  refsHtml += '</ol></div>';
}

const { prev, next } = getChapterNavigation(slug);
const position = getChapterPosition(slug);

// Determine chapter label
let chapterLabel = '';
if (chapter.partNumber && chapter.chapterNumber) {
  chapterLabel = `Part ${chapter.partNumber} · Chapter ${chapter.chapterNumber}`;
} else {
  chapterLabel = 'Front Matter';
}
---

<Layout title={`${chapter.title} — Society in Silico`} description={`Read "${chapter.title}" from Society in Silico by Max Ghenis`}>
  <div class="min-h-screen bg-[var(--color-paper)] relative" id="reader-container">
    <!-- Paper texture overlay -->
    <div class="fixed inset-0 pointer-events-none opacity-[0.012]" style="background-image: url('data:image/svg+xml,%3Csvg viewBox=\'0 0 400 400\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cfilter id=\'noiseFilter\'%3E%3CfeTurbulence type=\'fractalNoise\' baseFrequency=\'0.9\' numOctaves=\'4\' stitchTiles=\'stitch\'/%3E%3C/filter%3E%3Crect width=\'100%25\' height=\'100%25\' filter=\'url(%23noiseFilter)\'/%3E%3C/svg%3E');"></div>

    <!-- Top Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-[var(--color-paper)]/95 backdrop-blur-sm border-b border-[var(--color-paper-dark)]">
      <div class="max-w-4xl mx-auto px-6 py-3 flex items-center justify-between">
        <!-- Left: Book title / TOC link -->
        <a href="/book" class="flex items-center gap-2 font-display text-sm text-[var(--color-ink-muted)] hover:text-[var(--color-sienna)] transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
          </svg>
          <span class="hidden sm:inline">Contents</span>
        </a>

        <!-- Center: Progress -->
        <div class="flex items-center gap-3">
          <span class="font-mono text-[10px] tracking-wider text-[var(--color-ink-muted)] uppercase">
            {position.current} of {position.total}
          </span>
          <div class="w-24 h-1 bg-[var(--color-paper-dark)] rounded-full overflow-hidden">
            <div
              class="h-full bg-[var(--color-sienna)] rounded-full transition-all duration-300"
              style={`width: ${(position.current / position.total) * 100}%`}
            ></div>
          </div>
        </div>

        <!-- Right: Reading controls -->
        <div class="flex items-center gap-4">
          <button
            id="font-decrease"
            class="p-2 text-[var(--color-ink-muted)] hover:text-[var(--color-sienna)] transition-colors"
            aria-label="Decrease font size"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
            </svg>
          </button>
          <span class="font-mono text-xs text-[var(--color-ink-muted)]" id="font-size-label">100%</span>
          <button
            id="font-increase"
            class="p-2 text-[var(--color-ink-muted)] hover:text-[var(--color-sienna)] transition-colors"
            aria-label="Increase font size"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
          </button>
        </div>
      </div>
    </nav>

    <!-- Reading Progress Bar -->
    <div class="fixed top-[53px] left-0 right-0 z-40 h-0.5 bg-[var(--color-paper-dark)]">
      <div
        id="reading-progress"
        class="h-full bg-gradient-to-r from-[var(--color-sienna)] to-[var(--color-gold)] transition-all duration-150"
        style="width: 0%"
      ></div>
    </div>

    <!-- Main Content -->
    <main class="relative z-10 pt-20 pb-32">
      <!-- Chapter Header -->
      <header class="px-6 py-12 md:py-20 text-center border-b border-[var(--color-paper-dark)]">
        <div class="max-w-2xl mx-auto">
          <!-- Chapter marker -->
          <div class="animate-fade-up">
            <span class="inline-block font-mono text-[10px] tracking-[0.3em] text-[var(--color-sienna)] uppercase mb-6">
              {chapterLabel}
            </span>
          </div>

          <!-- Title -->
          <h1 class="font-display text-4xl md:text-5xl lg:text-6xl font-semibold leading-[1.1] tracking-tight text-[var(--color-ink)] mb-6 animate-fade-up delay-100">
            {chapter.title}
          </h1>

          <!-- Meta -->
          <div class="flex items-center justify-center gap-4 text-[var(--color-ink-muted)] animate-fade-up delay-200">
            <span class="font-mono text-xs">
              {readingTime} min read
            </span>
            <span class="w-1 h-1 rounded-full bg-[var(--color-ink-muted)]"></span>
            <span class="font-mono text-xs">
              {wordCount.toLocaleString()} words
            </span>
          </div>
        </div>
      </header>

      <!-- Article Content -->
      <article class="px-6 py-12 md:py-16" id="article-content">
        <div class="prose-container max-w-2xl mx-auto animate-fade-up delay-300" set:html={htmlContent} />
        {refsHtml && (
          <div class="max-w-2xl mx-auto mt-8 pt-8 border-t border-[var(--color-paper-dark)]" set:html={refsHtml} />
        )}
      </article>

      <!-- Chapter Navigation -->
      <nav class="px-6 py-12 border-t border-[var(--color-paper-dark)]">
        <div class="max-w-2xl mx-auto flex items-stretch justify-between gap-4">
          <!-- Previous -->
          {prev ? (
            <a
              href={`/book/${prev.slug}`}
              class="group flex-1 flex flex-col items-start p-6 bg-white/50 hover:bg-white border border-[var(--color-paper-dark)] hover:border-[var(--color-sienna)] transition-all"
            >
              <span class="font-mono text-[10px] tracking-wider text-[var(--color-ink-muted)] uppercase mb-2 flex items-center gap-2">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Previous
              </span>
              <span class="font-display text-lg text-[var(--color-ink)] group-hover:text-[var(--color-sienna)] transition-colors line-clamp-2">
                {prev.title}
              </span>
            </a>
          ) : (
            <div class="flex-1"></div>
          )}

          <!-- Center: TOC -->
          <a
            href="/book"
            class="flex items-center justify-center p-6 bg-white/50 hover:bg-white border border-[var(--color-paper-dark)] hover:border-[var(--color-sienna)] transition-all"
          >
            <svg class="w-5 h-5 text-[var(--color-ink-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
            </svg>
          </a>

          <!-- Next -->
          {next ? (
            <a
              href={`/book/${next.slug}`}
              class="group flex-1 flex flex-col items-end p-6 bg-white/50 hover:bg-white border border-[var(--color-paper-dark)] hover:border-[var(--color-sienna)] transition-all text-right"
            >
              <span class="font-mono text-[10px] tracking-wider text-[var(--color-ink-muted)] uppercase mb-2 flex items-center gap-2">
                Next
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </span>
              <span class="font-display text-lg text-[var(--color-ink)] group-hover:text-[var(--color-sienna)] transition-colors line-clamp-2">
                {next.title}
              </span>
            </a>
          ) : (
            <div class="flex-1"></div>
          )}
        </div>
      </nav>
    </main>

    <!-- Keyboard shortcuts hint -->
    <div class="fixed bottom-6 right-6 z-40 hidden lg:block">
      <div class="font-mono text-[10px] text-[var(--color-ink-muted)] space-y-1 opacity-50 hover:opacity-100 transition-opacity">
        <div class="flex items-center gap-2">
          <kbd class="px-1.5 py-0.5 bg-[var(--color-paper-dark)] rounded text-[9px]">←</kbd>
          <kbd class="px-1.5 py-0.5 bg-[var(--color-paper-dark)] rounded text-[9px]">→</kbd>
          <span>Navigate</span>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style is:global>
  /* Prose styling for the book content */
  .prose-container {
    font-family: var(--font-body);
    font-size: var(--reader-font-size, 1.125rem);
    line-height: 1.8;
    color: var(--color-ink);
  }

  .prose-container h1,
  .prose-container h2,
  .prose-container h3,
  .prose-container h4 {
    font-family: var(--font-display);
    font-weight: 600;
    color: var(--color-ink);
    margin-top: 2.5em;
    margin-bottom: 0.75em;
    line-height: 1.3;
  }

  .prose-container h1 {
    font-size: 2rem;
    border-bottom: 1px solid var(--color-paper-dark);
    padding-bottom: 0.5em;
  }

  .prose-container h2 {
    font-size: 1.5rem;
    margin-top: 3em;
  }

  .prose-container h3 {
    font-size: 1.25rem;
  }

  .prose-container p {
    margin-bottom: 1.5em;
  }

  .prose-container blockquote {
    margin: 2em 0;
    padding: 1.5em 2em;
    background: linear-gradient(135deg, var(--color-paper-dark) 0%, transparent 100%);
    border-left: 3px solid var(--color-sienna);
    font-family: var(--font-display);
    font-style: italic;
    color: var(--color-ink-light);
    font-size: 1.1em;
    line-height: 1.7;
  }

  .prose-container blockquote p {
    margin-bottom: 0;
  }

  .prose-container a {
    color: var(--color-sienna);
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-thickness: 1px;
    transition: all 0.2s;
  }

  .prose-container a:hover {
    color: var(--color-sienna-light);
    text-decoration-thickness: 2px;
  }

  .prose-container ul,
  .prose-container ol {
    margin: 1.5em 0;
    padding-left: 1.5em;
  }

  .prose-container li {
    margin-bottom: 0.5em;
  }

  .prose-container ul li::marker {
    color: var(--color-sienna);
  }

  .prose-container ol li::marker {
    color: var(--color-sienna);
    font-family: var(--font-mono);
    font-size: 0.9em;
  }

  .prose-container hr {
    margin: 3em auto;
    border: none;
    width: 100px;
    height: 1px;
    background: var(--color-paper-dark);
  }

  .prose-container hr::after {
    content: '§';
    display: block;
    text-align: center;
    margin-top: -0.7em;
    color: var(--color-ink-muted);
    font-family: var(--font-display);
    font-size: 1rem;
    background: var(--color-paper);
    width: 2em;
    margin-left: auto;
    margin-right: auto;
  }

  .prose-container code {
    font-family: var(--font-mono);
    font-size: 0.875em;
    background: var(--color-paper-dark);
    padding: 0.2em 0.4em;
    border-radius: 3px;
    color: var(--color-ink-light);
  }

  .prose-container pre {
    margin: 2em 0;
    padding: 1.5em;
    background: var(--color-ink);
    color: var(--color-paper);
    border-radius: 4px;
    overflow-x: auto;
    font-size: 0.875em;
    line-height: 1.6;
  }

  .prose-container pre code {
    background: none;
    padding: 0;
    color: inherit;
  }

  .prose-container table {
    width: 100%;
    margin: 2em 0;
    border-collapse: collapse;
    font-size: 0.9em;
  }

  .prose-container th,
  .prose-container td {
    padding: 0.75em 1em;
    border: 1px solid var(--color-paper-dark);
    text-align: left;
  }

  .prose-container th {
    background: var(--color-paper-dark);
    font-family: var(--font-mono);
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 500;
  }

  .prose-container tr:nth-child(even) {
    background: rgba(240, 237, 232, 0.3);
  }

  .prose-container strong {
    font-weight: 600;
    color: var(--color-ink);
  }

  .prose-container em {
    font-style: italic;
  }

  /* First paragraph drop cap */
  .prose-container > p:first-of-type::first-letter {
    float: left;
    font-family: var(--font-display);
    font-size: 3.5em;
    line-height: 0.8;
    padding-right: 0.1em;
    padding-top: 0.1em;
    color: var(--color-sienna);
    font-weight: 600;
  }

  /* Animation */
  @keyframes fadeUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-up {
    animation: fadeUp 0.6s ease-out forwards;
    opacity: 0;
  }

  .delay-100 { animation-delay: 100ms; }
  .delay-200 { animation-delay: 200ms; }
  .delay-300 { animation-delay: 300ms; }

  /* Line clamp utility */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Citations */
  .prose-container .cite {
    font-family: var(--font-mono);
    font-size: 0.7em;
    color: var(--color-sienna);
    cursor: pointer;
    vertical-align: super;
    line-height: 0;
    position: relative;
    display: inline-block;
  }

  .prose-container .cite:hover {
    color: var(--color-sienna-light);
  }

  .prose-container .cite::after {
    content: attr(data-tip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-ink);
    color: var(--color-paper);
    padding: 0.4em 0.6em;
    border-radius: 3px;
    font-size: 1.3em;
    white-space: nowrap;
    z-index: 100;
    pointer-events: none;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.15s ease, visibility 0.15s ease;
  }

  .prose-container .cite:hover::after {
    opacity: 1;
    visibility: visible;
  }

  /* Concepts */
  .prose-container .concept {
    background: linear-gradient(to bottom, transparent 60%, rgba(201, 85, 61, 0.15) 60%);
    cursor: help;
    position: relative;
    display: inline;
  }

  .prose-container .concept:hover {
    background: linear-gradient(to bottom, transparent 60%, rgba(201, 85, 61, 0.3) 60%);
  }

  .prose-container .concept::after {
    content: attr(data-tip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-ink);
    color: var(--color-paper);
    padding: 0.5em 0.75em;
    border-radius: 3px;
    font-size: 0.85em;
    max-width: 250px;
    white-space: normal;
    z-index: 100;
    pointer-events: none;
    text-align: center;
    line-height: 1.4;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.15s ease, visibility 0.15s ease;
  }

  .prose-container .concept:hover::after {
    opacity: 1;
    visibility: visible;
  }

  /* References section */
  .refs {
    font-size: 0.9rem;
    color: var(--color-ink-muted);
  }

  .refs h3 {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-ink);
    margin-bottom: 0.75rem;
  }

  .refs ol {
    padding-left: 1.25rem;
    margin: 0;
  }

  .refs li {
    margin-bottom: 0.5rem;
    line-height: 1.5;
  }

  .refs li::marker {
    color: var(--color-sienna);
    font-family: var(--font-mono);
    font-size: 0.85em;
  }

  .refs a {
    color: var(--color-ink-muted);
    text-decoration: none;
  }

  .refs a:hover {
    color: var(--color-sienna);
  }
</style>

<script>
  // Reading progress tracking
  function updateReadingProgress() {
    const article = document.getElementById('article-content');
    if (!article) return;

    const windowHeight = window.innerHeight;
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const scrollY = window.scrollY;

    const progress = Math.min(
      Math.max((scrollY - articleTop + windowHeight * 0.5) / articleHeight, 0),
      1
    );

    const progressBar = document.getElementById('reading-progress');
    if (progressBar) {
      progressBar.style.width = `${progress * 100}%`;
    }
  }

  // Font size controls
  let fontSize = 100;
  const minFontSize = 80;
  const maxFontSize = 140;

  function updateFontSize() {
    const container = document.querySelector('.prose-container') as HTMLElement;
    const label = document.getElementById('font-size-label');
    if (container) {
      container.style.setProperty('--reader-font-size', `${fontSize / 100 * 1.125}rem`);
    }
    if (label) {
      label.textContent = `${fontSize}%`;
    }
    localStorage.setItem('reader-font-size', String(fontSize));
  }

  // Load saved font size
  const savedFontSize = localStorage.getItem('reader-font-size');
  if (savedFontSize) {
    fontSize = parseInt(savedFontSize, 10);
    updateFontSize();
  }

  document.getElementById('font-decrease')?.addEventListener('click', () => {
    if (fontSize > minFontSize) {
      fontSize -= 10;
      updateFontSize();
    }
  });

  document.getElementById('font-increase')?.addEventListener('click', () => {
    if (fontSize < maxFontSize) {
      fontSize += 10;
      updateFontSize();
    }
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;

    if (e.key === 'ArrowLeft') {
      const prevLink = document.querySelector('a[href*="/book/"][href]:not([href="/book"])') as HTMLAnchorElement;
      const navLinks = document.querySelectorAll('nav a[href*="/book/"]');
      navLinks.forEach((link) => {
        if (link.textContent?.includes('Previous')) {
          (link as HTMLAnchorElement).click();
        }
      });
    }

    if (e.key === 'ArrowRight') {
      const navLinks = document.querySelectorAll('nav a[href*="/book/"]');
      navLinks.forEach((link) => {
        if (link.textContent?.includes('Next')) {
          (link as HTMLAnchorElement).click();
        }
      });
    }
  });

  // Initialize
  window.addEventListener('scroll', updateReadingProgress, { passive: true });
  updateReadingProgress();

  // Citation click to open URL
  document.querySelectorAll('.cite').forEach((cite) => {
    cite.addEventListener('click', (e) => {
      const url = (e.target as HTMLElement).dataset.url;
      if (url) {
        window.open(url, '_blank', 'noopener');
      }
    });
  });
</script>
